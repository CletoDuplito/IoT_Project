// Any copyright is dedicated to the Public Domain.
// http://creativecommons.org/publicdomain/zero/1.0/

/*********************************************
This camera example takes a picture. If a
directory is specified with the --upload-dir
flag, the picture is saved to that directory.
*********************************************/
var https = require('https');
var tessel = require('tessel');
var camera = require('../').use(tessel.port['A']); // Replace '../' with 'camera-vc0706' in your own code

var notificationLED = tessel.led[3]; // Set up an LED to notify when we're taking a picture

// Wait for the camera module to say it's ready
camera.on('ready', function() {
  notificationLED.high();
  // Take the picture
  camera.takePicture(function(err, image) {
    if (err) {
      console.log('error taking image', err);
    } else {
      notificationLED.low();
      // Name the image
      var name = 'picture-' + Math.floor(Date.now()*1000) + '.jpg';
      // Save the image
      console.log('Picture saving as', name, '...');
      process.sendfile(name, image);
      console.log('done.');
      sendToAercloud(name);
      // Turn the camera off to end the script
      camera.disable();
    }
  });
});


function sendToAercloud(imageName)  {
  var req = https.request ({
    port: 443,
    method: 'POST',
    hostname: 'api.aercloud.aeris.com',
    path: '/v1/16089/scls/camera-vc0706/containers/group8Container/contentInstances?apiKey='+ '76a29806-eb01-11e5-9830-2ff7af10cf1d',
    headers: {
      host: 'api.aercloud.aeris.com',
      'Accept': 'application/json, text/plain, */*',
        'Content-Type': 'application/json',
        'User-Agent': 'tessel'
    }
  }, function(res) { 
      console.log('statusCode: ', res.statusCode);
  }); console.log('{"nameOfImg": ' +'"'+imageName +'"' +'}'); 
  req.write('{"nameOfImg": ' +'"'+imageName +'"' +'}');
  req.end();
  req.on('error', function(e) { 
      console.error("error posting data to your container",e); 
  });
};

camera.on('error', function(err) {
  console.error(err);
});
